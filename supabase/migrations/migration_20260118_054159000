-- 创建TikTok账号配置表
CREATE TABLE IF NOT EXISTS tiktok_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT NOT NULL UNIQUE,
  password_encrypted TEXT NOT NULL,
  session_token TEXT,
  cookies JSONB,
  is_active BOOLEAN DEFAULT true,
  last_login_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建TikTok官方热门商机表
CREATE TABLE IF NOT EXISTS tiktok_opportunities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  opportunity_id TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  category TEXT NOT NULL,
  countries TEXT[],
  estimated_sales BIGINT,
  growth_rate DECIMAL,
  competition_level TEXT,
  recommended_price_range JSONB,
  insights TEXT[],
  data_source TEXT DEFAULT 'tiktok_official',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建TikTok商品榜单表
CREATE TABLE IF NOT EXISTS tiktok_rankings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ranking_type TEXT NOT NULL CHECK (ranking_type IN ('hot_selling', 'trending', 'new_arrivals')),
  rank INTEGER NOT NULL,
  product_id TEXT NOT NULL,
  product_name TEXT NOT NULL,
  category TEXT,
  country TEXT NOT NULL,
  sales_volume BIGINT,
  price DECIMAL,
  growth_rate DECIMAL,
  image_url TEXT,
  shop_name TEXT,
  data_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(ranking_type, country, rank, data_date)
);

-- 创建TikTok热门关键词表
CREATE TABLE IF NOT EXISTS tiktok_keywords (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  keyword TEXT NOT NULL,
  country TEXT NOT NULL,
  search_volume BIGINT,
  growth_rate DECIMAL,
  competition_score INTEGER,
  related_keywords TEXT[],
  suggested_products TEXT[],
  data_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(keyword, country, data_date)
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_tiktok_opportunities_category ON tiktok_opportunities(category);
CREATE INDEX IF NOT EXISTS idx_tiktok_rankings_type_country ON tiktok_rankings(ranking_type, country);
CREATE INDEX IF NOT EXISTS idx_tiktok_rankings_date ON tiktok_rankings(data_date DESC);
CREATE INDEX IF NOT EXISTS idx_tiktok_keywords_country ON tiktok_keywords(country);
CREATE INDEX IF NOT EXISTS idx_tiktok_keywords_date ON tiktok_keywords(data_date DESC);

-- 启用行级安全
ALTER TABLE tiktok_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE tiktok_opportunities ENABLE ROW LEVEL SECURITY;
ALTER TABLE tiktok_rankings ENABLE ROW LEVEL SECURITY;
ALTER TABLE tiktok_keywords ENABLE ROW LEVEL SECURITY;

-- 创建RLS策略
CREATE POLICY "Anyone can manage tiktok accounts" ON tiktok_accounts FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Anyone can read opportunities" ON tiktok_opportunities FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Anyone can read rankings" ON tiktok_rankings FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Anyone can read keywords" ON tiktok_keywords FOR ALL USING (true) WITH CHECK (true);

-- 创建更新时间触发器
CREATE TRIGGER update_tiktok_accounts_updated_at 
  BEFORE UPDATE ON tiktok_accounts
  FOR EACH ROW 
  EXECUTE FUNCTION update_tiktok_updated_at();

CREATE TRIGGER update_tiktok_opportunities_updated_at 
  BEFORE UPDATE ON tiktok_opportunities
  FOR EACH ROW 
  EXECUTE FUNCTION update_tiktok_updated_at();

COMMENT ON TABLE tiktok_accounts IS 'TikTok Shop账号配置，用于登录获取官方数据';
COMMENT ON TABLE tiktok_opportunities IS 'TikTok Shop官方推荐的热门商机';
COMMENT ON TABLE tiktok_rankings IS 'TikTok Shop商品榜单（热销、趋势、新品）';
COMMENT ON TABLE tiktok_keywords IS 'TikTok Shop热门搜索关键词';